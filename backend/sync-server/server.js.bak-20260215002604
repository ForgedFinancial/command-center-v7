require("dotenv").config();
// Command Center Backend API Server
// Enables bidirectional communication with Openclaw/Claude
// Version: 1.0.0

const express = require('express');
const cors = require('cors');
const bodyParser = require('body-parser');
const https = require("https");
const fsSync = require("fs");
const fs = require('fs').promises;
const path = require('path');

// Import data collectors
const emailCollector = require('./collectors/email');
const financeCollector = require('./collectors/finance');
const calendarCollector = require('./collectors/calendar');
const adsCollector = require('./collectors/ads');
const weatherCollector = require('./collectors/weather');

const app = express();
const PORT = process.env.PORT || 3737;
const API_KEY = process.env.CC_API_KEY || 'CHANGE_ME_IN_ENV_FILE';

// Middleware
app.use(cors());
app.use(bodyParser.json({ limit: '10mb' }));
app.use(express.static('cc')); // Serve index.html from cc/ folder

// In-memory event queue (would use Redis in production)
const eventQueue = [];
const MAX_QUEUE_SIZE = 1000;

// Authentication middleware
function authenticateAPI(req, res, next) {
  const authHeader = req.headers['authorization'];
  const token = authHeader && authHeader.split(' ')[1]; // Bearer TOKEN

  if (!token || token !== API_KEY) {
    console.warn(`[AUTH FAIL] Invalid token attempt from ${req.ip}`);
    return res.status(403).json({ error: 'Invalid or missing API key' });
  }

  next();
}

// Utility: Generate unique ID
function generateId() {
  return 'id_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);
}

// === EXISTING ENDPOINTS (from frontend sync bridge) ===

// POST /api/push - Accept updates from Command Center
app.post('/api/push', authenticateAPI, (req, res) => {
  const { type, action, data, source } = req.body;

  if (!type || !action || !data) {
    return res.status(400).json({ error: 'Missing required fields: type, action, data' });
  }

  console.log(`[PUSH] ${type}/${action} from ${source || 'unknown'}`);

  // Store event
  eventQueue.push({
    id: generateId(),
    ts: new Date().toISOString(),
    type,
    action,
    data,
    source: source || 'cc'
  });

  // Trim queue if too large
  if (eventQueue.length > MAX_QUEUE_SIZE) {
    eventQueue.shift();
  }

  res.json({ success: true, queued: true, timestamp: new Date().toISOString() });
});

// GET /api/poll - Command Center polls for updates
app.get('/api/poll', (req, res) => {
  const since = req.query.since || new Date(Date.now() - 3600000).toISOString();
  const sinceDate = new Date(since);

  const updates = eventQueue.filter(e => new Date(e.ts) > sinceDate);

  res.json({
    serverTime: new Date().toISOString(),
    count: updates.length,
    updates: updates.map(e => ({
      type: e.type,
      action: e.action,
      data: e.data,
      source: e.source,
      ts: e.ts
    }))
  });
});

// === NEW ENDPOINTS FOR OPENCLAW ===

// POST /api/openclaw/complete - Openclaw completes a task
app.post('/api/openclaw/complete', authenticateAPI, async (req, res) => {
  const {
    taskId,           // Required: which task was completed
    result,           // Required: text summary of what was done
    documents,        // Optional: array of generated documents
    attachments,      // Optional: array of file URLs
    nextActions,      // Optional: suggested follow-up tasks
    confidence,       // Optional: 0-100 confidence score
    timeSpent,        // Optional: seconds spent
    aiModel,          // Optional: which model was used
    error             // Optional: if partial completion/failure
  } = req.body;

  if (!taskId || !result) {
    return res.status(400).json({ error: 'taskId and result are required' });
  }

  console.log(`[OPENCLAW COMPLETE] Task ${taskId} - Confidence: ${confidence || 100}%`);

  // Create task update event
  const updateEvent = {
    id: generateId(),
    ts: new Date().toISOString(),
    type: 'task',
    action: 'complete',
    source: 'openclaw',
    data: {
      id: taskId,
      status: 'review', // Always move to Review for approval
      completedAt: new Date().toISOString(),
      aiResult: {
        summary: result,
        confidence: confidence || 100,
        model: aiModel || 'openclaw-v2',
        timeSpent: timeSpent || null,
        completedBy: 'openclaw',
        error: error || null
      },
      resultDocuments: documents || [],
      attachments: attachments || [],
      nextActions: nextActions || []
    }
  };

  eventQueue.push(updateEvent);

  // If documents were created, add them as separate events
  if (documents && documents.length > 0) {
    documents.forEach(doc => {
      eventQueue.push({
        id: generateId(),
        ts: new Date().toISOString(),
        type: 'document',
        action: 'create',
        source: 'openclaw',
        data: {
          id: doc.id || generateId(),
          title: doc.title,
          content: doc.content,
          body: doc.content,
          type: doc.type || 'deliverable',
          taskId: taskId,
          by: 'openclaw',
          source: 'openclaw',
          at: new Date().toISOString(),
          tags: ['openclaw', 'auto-generated']
        }
      });
    });
  }

  // Add activity log
  eventQueue.push({
    id: generateId(),
    ts: new Date().toISOString(),
    type: 'log',
    action: 'add',
    source: 'openclaw',
    data: {
      id: generateId(),
      ts: new Date().toISOString(),
      type: 'success',
      op: 'openclaw',
      txt: `Completed: "${result.substring(0, 60)}${result.length > 60 ? '...' : ''}"`,
      sub: error ? `âš ï¸ ${error}` : 'âœ… Ready for review',
      ico: error ? 'warning' : 'success'
    }
  });

  res.json({
    success: true,
    taskId,
    status: 'moved to review',
    documentsCreated: documents?.length || 0,
    timestamp: new Date().toISOString()
  });
});

// POST /api/openclaw/progress - Openclaw reports progress
app.post('/api/openclaw/progress', authenticateAPI, (req, res) => {
  const { taskId, status, progress, message, currentStep } = req.body;

  if (!taskId) {
    return res.status(400).json({ error: 'taskId is required' });
  }

  console.log(`[OPENCLAW PROGRESS] Task ${taskId}: ${message || 'Working...'}`);

  // Update operator status
  eventQueue.push({
    id: generateId(),
    ts: new Date().toISOString(),
    type: 'operator',
    action: 'update',
    source: 'openclaw',
    data: {
      id: 'openclaw',
      status: status || 'working',
      task: message || 'Working...',
      currentTaskId: taskId,
      progress: progress || null
    }
  });

  res.json({ success: true, logged: true });
});

// POST /api/openclaw/error - Openclaw reports error
app.post('/api/openclaw/error', authenticateAPI, (req, res) => {
  const { taskId, error, details, recoverable } = req.body;

  if (!taskId || !error) {
    return res.status(400).json({ error: 'taskId and error are required' });
  }

  console.error(`[OPENCLAW ERROR] Task ${taskId}: ${error}`);

  // Add remediation to task
  eventQueue.push({
    id: generateId(),
    ts: new Date().toISOString(),
    type: 'task',
    action: 'update',
    source: 'openclaw',
    data: {
      id: taskId,
      status: recoverable ? 'in_progress' : 'review',
      remediations: [{
        at: new Date().toISOString(),
        by: 'openclaw',
        action: 'error',
        notes: `Error: ${error}${details ? ' | ' + details : ''}`
      }]
    }
  });

  // Add error log
  eventQueue.push({
    id: generateId(),
    ts: new Date().toISOString(),
    type: 'log',
    action: 'add',
    source: 'openclaw',
    data: {
      id: generateId(),
      ts: new Date().toISOString(),
      type: 'error',
      op: 'openclaw',
      txt: `Error: ${error}`,
      sub: details || '',
      ico: 'error'
    }
  });

  res.json({ success: true, logged: true });
});

// POST /api/claude/complete - Claude Code completes a task
app.post('/api/claude/complete', authenticateAPI, (req, res) => {
  const { taskId, result, documents, confidence } = req.body;

  if (!taskId || !result) {
    return res.status(400).json({ error: 'taskId and result are required' });
  }

  console.log(`[CLAUDE COMPLETE] Task ${taskId}`);

  // Same logic as openclaw but with 'claude' as source
  eventQueue.push({
    id: generateId(),
    ts: new Date().toISOString(),
    type: 'task',
    action: 'complete',
    source: 'claude',
    data: {
      id: taskId,
      status: 'review',
      completedAt: new Date().toISOString(),
      aiResult: {
        summary: result,
        confidence: confidence || 100,
        model: 'claude-sonnet-4.5',
        completedBy: 'claude'
      },
      resultDocuments: documents || []
    }
  });

  res.json({ success: true, taskId, status: 'moved to review' });
});

// === DASHBOARD DATA ENDPOINTS ===

// GET /api/dashboard/email - Email collector data
app.get('/api/dashboard/email', (req, res) => {
  try {
    const data = emailCollector.getData();
    res.json(data || { accounts: {}, lastPoll: null });
  } catch (err) {
    console.error('[DASHBOARD:EMAIL]', err.message);
    res.json({ accounts: {}, error: err.message });
  }
});

// GET /api/dashboard/finance - Finance collector data
app.get('/api/dashboard/finance', (req, res) => {
  try {
    const data = financeCollector.getData();
    res.json(data || { holdings: [], transactions: [], lastUpdate: null });
  } catch (err) {
    console.error('[DASHBOARD:FINANCE]', err.message);
    res.json({ holdings: [], transactions: [], error: err.message });
  }
});

// GET /api/dashboard/calendar - Calendar collector data
app.get('/api/dashboard/calendar', (req, res) => {
  try {
    const data = calendarCollector.getData();
    res.json(data || { events: [], lastPoll: null });
  } catch (err) {
    console.error('[DASHBOARD:CALENDAR]', err.message);
    res.json({ events: [], error: err.message });
  }
});

// GET /api/dashboard/ads - Ads collector data
app.get('/api/dashboard/ads', (req, res) => {
  try {
    const data = adsCollector.getData();
    res.json(data || { campaigns: [], lastUpdate: null });
  } catch (err) {
    console.error('[DASHBOARD:ADS]', err.message);
    res.json({ campaigns: [], error: err.message });
  }
});

// GET /api/dashboard/weather - Weather collector data
app.get('/api/dashboard/weather', (req, res) => {
  try {
    const data = weatherCollector.getData();
    res.json(data || { current: null, forecast: [], lastUpdate: null });
  } catch (err) {
    console.error('[DASHBOARD:WEATHER]', err.message);
    res.json({ current: null, forecast: [], error: err.message });
  }
});

// GET /api/health - Health check
app.get('/api/health', (req, res) => {
  res.json({
    status: 'ok',
    uptime: Math.floor(process.uptime()),
    queueSize: eventQueue.length,
    timestamp: new Date().toISOString(),
    version: '1.0.0',
    apiKeyConfigured: API_KEY !== 'CHANGE_ME_IN_ENV_FILE'
  });
});

// GET / - Serve Command Center UI
app.get('/', (req, res) => {
  res.sendFile(path.join(__dirname, 'cc', 'index.html'));
});

// === ERROR HANDLERS ===

// 404 handler
app.use((req, res) => {
  res.status(404).json({
    error: 'Endpoint not found',
    availableEndpoints: [
      'GET /api/health',
      'GET /api/poll',
      'GET /api/dashboard/email',
      'GET /api/dashboard/finance',
      'GET /api/dashboard/calendar',
      'GET /api/dashboard/ads',
      'GET /api/dashboard/weather',
      'POST /api/push',
      'POST /api/openclaw/complete',
      'POST /api/openclaw/progress',
      'POST /api/openclaw/error',
      'POST /api/claude/complete'
    ]
  });
});

// Global error handler
app.use((err, req, res, next) => {
  console.error('[ERROR]', err);
  res.status(500).json({
    error: 'Internal server error',
    message: err.message
  });
});

const sslOptions = {
  key: fsSync.readFileSync(path.join(__dirname, "server.key")),
  cert: fsSync.readFileSync(path.join(__dirname, "server.cert"))
};

// === START SERVER ===
https.createServer(sslOptions, app).listen(PORT, () => {
  console.log('');
  console.log('âœ… Command Center API Server Started');
  console.log('=====================================');
  console.log(`ğŸ“¡ Port: ${PORT}`);
  console.log(`ğŸ”‘ API Key: ${API_KEY.substring(0, 8)}...`);
  console.log(`ğŸŒ Health: http://localhost:${PORT}/api/health`);
  console.log(`ğŸ“‹ Ready for webhook calls from Openclaw/Claude`);
  console.log('');

  if (API_KEY === 'CHANGE_ME_IN_ENV_FILE') {
    console.warn('âš ï¸  WARNING: Using default API key! Set CC_API_KEY in .env file');
  }

  // Start data collectors
  console.log('ğŸ“Š Starting data collectors...');
  try {
    // Wire finance collector to email collector for financial email classification
    financeCollector.setEmailCollector(emailCollector);

    emailCollector.start();
    console.log('   âœ“ Email collector started');

    financeCollector.start();
    console.log('   âœ“ Finance collector started');

    calendarCollector.start();
    console.log('   âœ“ Calendar collector started');

    adsCollector.start();
    console.log('   âœ“ Ads collector started');

    weatherCollector.start();
    console.log('   âœ“ Weather collector started');

    console.log('ğŸ“Š All collectors running');
  } catch (err) {
    console.error('âš ï¸  Collector startup error:', err.message);
    console.log('   Dashboard endpoints will return empty data');
  }
});
